<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JSON → Lean Export Visualizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; }
    header { padding: 12px 16px; border-bottom: 1px solid #eee; display: flex; gap: 12px; align-items: center; }
    main { display: grid; grid-template-columns: 360px 1fr; height: calc(100vh - 53px); }
    aside { border-right: 1px solid #eee; overflow: auto; }
    section { height: 100%; overflow: auto; }
    .toolbar { display: flex; gap: 8px; align-items: center; }
    .file-list { list-style: none; margin: 0; padding: 0; }
    .file-list li { padding: 8px 12px; border-bottom: 1px solid #f3f3f3; cursor: pointer; }
    .file-list li:hover { background: #fafafa; }
    .file-list li.active { background: #eef6ff; }
    .panel { padding: 12px 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    textarea, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    pre { background: #fafafa; border: 1px solid #eee; border-radius: 6px; padding: 10px; white-space: pre-wrap; word-break: break-word; }
    .muted { color: #666; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 999px; background: #eef2ff; color: #3f3f46; font-size: 11px; margin-left: 6px; }
    .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .search { display: flex; gap: 8px; }
  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <label>
        JSON 文件
        <input type="file" id="jsonInput" accept="application/json" />
      </label>
      <label>
        Lean 目录
        <input type="file" id="leanDirInput" webkitdirectory directory multiple />
      </label>
      <input id="filter" class="search" type="search" placeholder="Filter by id or text…" />
      <span class="badge" id="summary">0 items</span>
      <button id="chooseOutDir" title="选择一个输出文件夹用于保存 Block_XXX.lean">选择输出目录</button>
      <span class="muted" id="outDirName"></span>
      <button id="exportAll" disabled title="将 JSON 中的语句导出为 Block_XXX.lean">导出到所选目录</button>
      <button id="zipDownload" title="将导出内容打包为 ZIP 下载">打包 ZIP 下载</button>
    </div>
  </header>
  <main>
    <aside>
      <ul class="file-list" id="list"></ul>
    </aside>
    <section>
      <div class="panel">
        <div class="split">
          <div>
            <h3>JSON Item <span class="muted" id="jsonMeta"></span></h3>
            <pre id="jsonPreview">Load a JSON file to start…</pre>
          </div>
          <div>
            <h3>Lean Block <span class="muted" id="leanMeta"></span></h3>
            <pre id="leanPreview">Select an item to view matching Lean content…</pre>
          </div>
        </div>
      </div>
    </section>
  </main>
  <script>
    // Optional ZIP fallback library
    (function addZipCdn(){
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
      s.defer = true;
      document.head.appendChild(s);
    })();

    const listEl = document.getElementById('list');
    const jsonInput = document.getElementById('jsonInput');
    const leanDirInput = document.getElementById('leanDirInput');
    const jsonPreview = document.getElementById('jsonPreview');
    const leanPreview = document.getElementById('leanPreview');
    const jsonMeta = document.getElementById('jsonMeta');
    const leanMeta = document.getElementById('leanMeta');
    const filterEl = document.getElementById('filter');
    const summary = document.getElementById('summary');
    const chooseOutDirBtn = document.getElementById('chooseOutDir');
    const outDirName = document.getElementById('outDirName');
    const exportAllBtn = document.getElementById('exportAll');
    const zipBtn = document.getElementById('zipDownload');

    let jsonItems = [];
    let leanFiles = new Map(); // name -> text
    let outDirHandle = null; // Directory handle for FS Access API

    jsonInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const text = await file.text();
      try {
        const data = JSON.parse(text);
        if (!Array.isArray(data)) throw new Error('JSON 顶层应为数组');
        jsonItems = data;
      } catch (err) {
        alert('解析 JSON 失败: ' + err.message);
        return;
      }
      renderList();
    });

    leanDirInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      const lean = files.filter(f => f.name.endsWith('.lean'));
      leanFiles.clear();
      for (const f of lean) {
        const text = await f.text();
        leanFiles.set(f.name, text);
      }
      if (listEl.children.length && listEl.querySelector('.active')) {
        const active = listEl.querySelector('.active');
        active.click();
      }
    });

    filterEl.addEventListener('input', () => renderList());

    chooseOutDirBtn.addEventListener('click', async () => {
      if (!('showDirectoryPicker' in window)) {
        alert('当前浏览器不支持选择输出目录（推荐使用 Chrome/Edge）。可使用“打包 ZIP 下载”作为替代。');
        return;
      }
      try {
        outDirHandle = await window.showDirectoryPicker();
        outDirName.textContent = '\uD83D\uDCC1 ' + (outDirHandle.name || '(已选择目录)');
        exportAllBtn.disabled = false;
      } catch (err) {
        if (err && err.name !== 'AbortError') {
          console.error(err);
          alert('选择目录失败: ' + err.message);
        }
      }
    });

    exportAllBtn.addEventListener('click', async () => {
      if (!outDirHandle) { alert('请先选择输出目录'); return; }
      if (!jsonItems.length) { alert('请先加载 JSON 文件'); return; }
      try {
        const { exported, skipped } = await exportJsonToDirectory(outDirHandle, jsonItems);
        alert(`导出完成：写入 ${exported} 个文件，跳过 ${skipped} 个空记录。`);
      } catch (err) {
        console.error(err);
        alert('导出失败: ' + (err?.message || String(err)));
      }
    });

    zipBtn.addEventListener('click', async () => {
      if (!jsonItems.length) { alert('请先加载 JSON 文件'); return; }
      if (!(window.JSZip)) {
        alert('ZIP 依赖未加载（请联网或改用导出到目录）。');
        return;
      }
      try {
        const zip = new JSZip();
        let exported = 0, skipped = 0;
        for (let i = 0; i < jsonItems.length; i++) {
          const idx = i + 1;
          const stmt = extractStmt(jsonItems[i]);
          if (!stmt) { skipped++; continue; }
          const name = makeBlockName(idx);
          zip.file(name, stmt + (stmt.endsWith('\n') ? '' : '\n'));
          exported++;
        }
        const blob = await zip.generateAsync({ type: 'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'lean-blocks.zip';
        a.click();
        URL.revokeObjectURL(a.href);
        alert(`ZIP 已生成：包含 ${exported} 个文件，${skipped} 个空记录跳过。`);
      } catch (err) {
        console.error(err);
        alert('ZIP 生成失败: ' + (err?.message || String(err)));
      }
    });

    function renderList() {
      const q = filterEl.value.trim().toLowerCase();
      listEl.innerHTML = '';
      const items = jsonItems.map((obj, i) => ({
        idx: i + 1,
        id: obj.id ?? i + 1,
        stmt: extractStmt(obj)
      })).filter(it => !q || String(it.id).toLowerCase().includes(q) || it.stmt.toLowerCase().includes(q));

      summary.textContent = items.length + ' items';

      for (const it of items) {
        const li = document.createElement('li');
        const fname = `Block_${String(it.idx).padStart(3,'0')}.lean`;
        const exists = leanFiles.has(fname);
        li.innerHTML = `<strong>#${it.idx}</strong> <span class="muted">id=${it.id}</span> ${exists ? '' : '<span class=badge>no lean</span>'}<br/><span class="muted">${escapeHtml(truncate(it.stmt, 120))}</span>`;
        li.addEventListener('click', () => selectItem(it));
        listEl.appendChild(li);
      }
    }

    function selectItem(it) {
      for (const li of listEl.children) li.classList.remove('active');
      // naive: reselect by index order
      const idx = Array.from(listEl.children).findIndex(node => node.textContent?.includes(`#${it.idx}`));
      if (idx >= 0) listEl.children[idx].classList.add('active');

      jsonMeta.textContent = `#${it.idx} id=${it.id}`;
      jsonPreview.textContent = (it.stmt || '').trim() || '(empty)';

      const fname = `Block_${String(it.idx).padStart(3,'0')}.lean`;
      const lean = leanFiles.get(fname);
      leanMeta.textContent = fname + (lean ? '' : ' (not found)');
      leanPreview.textContent = lean || '(no corresponding Lean file loaded)';
    }

    function extractStmt(obj) {
      return (obj && (obj['main theorem statement'] || obj.main_theorem_statement || obj.main_theorem || obj.statement || '')) || '';
    }
    function makeBlockName(idx) { return `Block_${String(idx).padStart(3,'0')}.lean`; }
    function truncate(s, n) { return s.length > n ? s.slice(0, n - 1) + '…' : s; }
    function escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    async function exportJsonToDirectory(dirHandle, items) {
      let exported = 0, skipped = 0;
      for (let i = 0; i < items.length; i++) {
        const idx = i + 1;
        const stmt = extractStmt(items[i]);
        if (!stmt || !stmt.trim()) { skipped++; continue; }
        const name = makeBlockName(idx);
        const fileHandle = await dirHandle.getFileHandle(name, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(stmt.endsWith('\n') ? stmt : (stmt + '\n'));
        await writable.close();
        exported++;
      }
      return { exported, skipped };
    }
  </script>
</body>
</html>
